<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "/WEB-INF/dtd/mybatis-3-mapper.dtd">
<mapper namespace="commissionSql">
	<insert id="commissionSql.insertWewon" parameterType="HashMap" >
		<selectKey keyProperty="wewoninfoid" resultType="int" order="BEFORE">
			SELECT KEYID.NEXTVAL FROM DUAL 
		</selectKey>
		INSERT INTO TB_LM_WEWONINFO
	 		(
	 			WEWONINFOID,
				STARTDT, 
				USERID,
				WEWONGBN 
			)	
		VALUES
			(
				#{wewoninfoid},
				sysdate,
				#{userno},
				'위원'
			)
	</insert>
	
	<insert id="commissionSql.insertCommission" parameterType="HashMap" >
		<selectKey keyProperty="commissionid" resultType="int" order="BEFORE">
			SELECT KEYID.NEXTVAL FROM DUAL 
		</selectKey>
		INSERT INTO TB_LM_COMMISSION
	 		(
	 			COMMISSIONID,
				METHODS, 
				CHA,
				TITLE,
				STARTTIME,
				ENDTIME, 
				PLACE,
				STATECD,
				INDT ,
				OPENYN,
				PROMULDT
			)	
		VALUES
			(
				#{commissionid},
				#{methods},
				#{cha},
				#{title},
				#{starttime},
				#{endtime},
				#{place},
				#{statecd},
				sysdate,
				#{openyn},
				#{promuldt}
			)
	</insert>
	
	<insert id="commissionSql.insertCommitee" parameterType="HashMap" >
		<selectKey keyProperty="commiteeid" resultType="int" order="BEFORE">
			SELECT KEYID.NEXTVAL FROM DUAL 
		</selectKey>
		INSERT INTO TB_LM_COMMITEE
	 		(
	 			COMMITEEID,
				WEWONINFOID, 
				COMMISSIONID
			)	

				SELECT  
					#{commiteeid}, 
					#{wewoninfoid}, 
					#{commissionid} 
				FROM TB_LM_WEWONINFO
				WHERE
					ENDDT IS NULL or ENDDT = ''
		
	</insert>
	
	<insert id="commissionSql.insertAngun" parameterType="HashMap" >
		<selectKey keyProperty="angunid" resultType="int" order="BEFORE">
			SELECT KEYID.NEXTVAL FROM DUAL 
		</selectKey>
		INSERT INTO TB_LM_ANGUN
			(	ANGUNID,
				COMMISSIONID, 
				BOOKID,
				STATEHISTORYID,
				INDT
			)
		VALUES
			(#{angunid},#{commissionid},#{bookid},(select max(statehistoryid) from tb_lm_statehistory where bookid=#{bookid} and stateid='1700' ),sysdate)
	</insert>
	
	<insert id="commissionSql.insertWewonopinion" parameterType="HashMap" >
		<selectKey keyProperty="opinionid" resultType="int" order="BEFORE">
			SELECT KEYID.NEXTVAL FROM DUAL 
		</selectKey>
		INSERT INTO TB_LM_WEWONOPINION
	 		(
	 			OPINIONID,
				COMMISSIONID, 
				USERNO,
				OPINION,
				OPGBN,
				YORN,
				INDT
			)	
		VALUES
		 	(
				#{opinionid},
				#{commissionid},
				#{userno},
				#{opinion},
				#{opgbn},
				#{yorn},
				sysdate
			)
	</insert>
	
	<insert id="commissionSql.insertOpinionYn" parameterType="HashMap" >
		<selectKey keyProperty="opinionynid" resultType="int" order="BEFORE">
			SELECT KEYID.NEXTVAL FROM DUAL 
		</selectKey>
		INSERT INTO TB_LM_OPINIONYN
	 		(
	 			OPINIONYNID,
			    OPINIONID,
			    USERNO,
			    BOOKID,
			    YORN
			)	
		VALUES
		 	(
				#{opinionynid},
				#{opinionid},
				#{userno},
				#{bookid},
				#{yorn}
			)
	</insert>
	
	<delete id="commissionSql.delWewon">
		DELETE FROM TB_LM_WEWONINFO WHERE WEWONINFOID = #{wewoninfoid}
	</delete>
	
	<delete id="commissionSql.deleteCommission">
		DELETE FROM TB_LM_COMMISSION WHERE COMMISSIONID = #{commissionid}
	</delete>
	
	<delete id="commissionSql.deleteCommitee">
		DELETE FROM TB_LM_COMMITEE WHERE COMMISSIONID = #{commissionid}
	</delete>
	
	<delete id="commissionSql.deleteAngun">
		DELETE FROM TB_LM_ANGUN WHERE COMMISSIONID = #{commissionid}
	</delete>
	
	<delete id="commissionSql.deleteWewonOpinion">
		DELETE FROM TB_LM_WEWONOPINION WHERE OPINIONID = #{opinionid}
	</delete>
	
	<delete id="commissionSql.deleteOpinionYn">
		DELETE FROM TB_LM_OPINIONYN WHERE OPINIONID = #{opinionid}
	</delete>
	
	<update id="commissionSql.updateWewon">
	 	UPDATE TB_LM_WEWONINFO
	 	<trim prefix="set " prefixOverrides=", ">
		 	<if test="startdt != null and startdt != ''">
				, STARTDT = #{startdt}
			</if>
			<if test="enddt != null and enddt != ''">
				, ENDDT = #{enddt}
			</if>
			<if test="enddt == null or enddt == ''">
				, ENDDT = ''
			</if>
			<if test="wewongbn != null and wewongbn != ''">
				, WEWONGBN = #{wewongbn}
			</if>
		</trim>
		WHERE 
			WEWONINFOID = #{wewoninfoid}
	 </update>
	 
	 <update id="commissionSql.updateCommission">
	 	UPDATE TB_LM_COMMISSION
	 	<trim prefix="set " prefixOverrides=", ">
			<if test="methods != null and methods != ''">		, METHODS = #{methods}		</if>
			<if test="cha != null and cha != ''">				, CHA	= #{cha}				</if>
			<if test="title != null and title != ''">			, TITLE	= #{title}		</if>
			<if test="starttime != null and starttime != ''">	, STARTTIME = #{starttime}	</if>
			<if test="endtime != null and endtime != ''">		, ENDTIME	= #{endtime}		</if>
			<if test="place != null and place != ''">			, PLACE	= #{place}		</if>
			<if test="statecd != null and statecd != ''">		, STATECD	= #{statecd}		</if>
			<if test="openyn != null and openyn != ''">			, openYn	= #{openyn}		</if>
			<if test="promuldt != null and promuldt != ''">		, promulDt	= #{promuldt}		</if>
			,UPDT = sysdate 
		</trim>	 	
		WHERE 
			COMMISSIONID = #{commissionid}
	 </update>
	 
	 <update id="commissionSql.updateWewonOpinion">
	 	UPDATE TB_LM_WEWONOPINION
	 	<trim prefix="set " prefixOverrides=", ">
			<if test="opinion != null and opinion != ''">	, OPINION = #{opinion}		</if>
			<if test="yorn != null and yorn != ''">			, YORN	= #{yorn}		</if>
			,UPDT = sysdate 
		</trim>	 	
		WHERE 
			OPINIONID = #{opinionid}
	 </update>	
	 
	 <select id="commissionSql.selectWewonGbn" resultType="String">
		SELECT b.WEWONGBN
		FROM tb_LM_commitee a, tb_lm_wewoninfo b
		WHERE a.wewoninfoid = b.wewoninfoid
		AND a.COMMISSIONID = #{commissionid}
		AND b.USERID = #{userid}
	</select>
	
	<select id="commissionSql.selectWewonList" resultType="HashMap">
	 	SELECT 
	 		WEWONINFOID,
	 		STARTDT,
	 		ENDDT,
	 		WEWONGBN,
	 		b.USER_NM AS USERNAME,
	 		b.USER_ID as USERID,
	 		c.DEPT_NM AS DEPTNM
	 	FROM TB_LM_WEWONINFO a, TB_COM_HRIS b, TB_COM_ORGCHT c
	 	WHERE
	 		a.USERID = b.USER_ID
	 	AND 
	 		b.DEPT_NO = c.DEPT_NO
	 	<if test="gridGbn == 'present' or gridGbn==null or gridGbn==''">
			AND (ENDDT IS NULL OR ENDDT ='') 
		</if>
		<if test="gridGbn == 'past'">
			AND (ENDDT IS NOT NULL and ENDDT !='') 
		</if>
		<if test="schTxt != null and schTxt != ''">
			and b.USER_NM like '%'||#{schTxt}||'%'
		</if>
	 </select>
	 
	 <select id="commissionSql.selectCommiteeList" resultType="HashMap">
	 	SELECT 
	 		a.WEWONINFOID,
	 		a.STARTDT,
	 		a.ENDDT,
	 		a.WEWONGBN,
	 		b.USERNAME,
	 		b.USERID,
	 		c.DEPTNAME
	 	FROM TB_LM_WEWONINFO a, TB_COM_HRIS b, TB_COM_ORGCHT c, TB_LM_COMMITEE d
	 	WHERE
	 		a.USERID = b.USERID
	 	AND 
	 		b.DEPTCD = c.DEPTCD
	 	AND
	 		a.WEWONINFOID = d.WEWONINFOID
	 	AND
	 		d.COMMISSIONID = #{commissionid}
	 	order by length(wewongbn) desc,wewongbn
	 </select>	
	 
	 <select id="commissionSql.selectCommissionList" resultType="HashMap">
		SELECT b.* FROM    
		(       
		    SELECT a.* , ceil(ROWNUM/#{pageSize})  page  FROM        
		    (           
			 	SELECT 
			 			aa.COMMISSIONID,
						aa.METHODS, 
						aa.CHA,
						aa.TITLE,
						aa.STARTTIME,
						aa.ENDTIME, 
						aa.PLACE,
						aa.STATECD				
			 	FROM TB_LM_COMMISSION aa
		    ) a   
		) b 
		where 1=1
			<if test="pageno != null and pageno != ''">
				and	page = #{pageno}-1
			</if>
			<if test="schtxt != null and schtxt != ''">
				and title like '%'||#{schtxt}||'%'
			</if>
	 </select> 
	 
	 <select id="commissionSql.selectCommissionListTot" resultType="int">
	 	SELECT 
	 			count(COMMISSIONID)
	 	FROM TB_LM_COMMISSION 
			<if test="schtxt != null and schtxt != ''">
				where title like '%'||#{schtxt}||'%'
			</if>
	 </select>	
	 
	 <select id="commissionSql.selectCommissionInfo" resultType="HashMap">
	 	SELECT 
				a.METHODS, 
				a.CHA,
				a.TITLE,
				a.STARTTIME,
				a.ENDTIME, 
				a.PLACE,
				a.STATECD,
				a.OPENYN,
				a.PROMULDT
	 	FROM TB_LM_COMMISSION a
	 	WHERE  a.COMMISSIONID = #{commissionid}
	 </select>
	 
	 <select id="commissionSql.selectLawList" resultType="HashMap">
		SELECT BOOKID,OBOOKID,TITLE,REVCD,REVCHA
			,(SELECT MAX(STATEHISTORYID) FROM TB_LM_STATEHISTORY WHERE BOOKID=A.BOOKID AND STATEID=A.STATECD) AS STATEHISTORYID
		FROM TB_LM_RULEHISTORY A
		WHERE STATECD='1700'
	</select>
	
	<!-- 위원회안건등록 -->
	<select id="commissionSql.selectAngun" resultType="HashMap">
		SELECT B.BOOKID, B.TITLE, B.BOOKCD, B.REVCD ,B.STATECD,B.STATECD,B.REVCHA,A.STATEHISTORYID,B.ACTIONYN,
			nvl(c.BYY,0) BYY,
	        nvl(c.BNN,0) BNN,
	        nvl(c.BUN,0) BUN,
	        nvl(c.BBN,0) BBN
		FROM TB_LM_ANGUN a, TB_LM_RULEHISTORY b,
		(
            SELECT bookid,MAX( DECODE( yorn, 'Y', cnt)) AS BYY
           , MAX( DECODE( yorn, 'N', cnt)) AS BNN
           , MAX( DECODE( yorn, 'U', cnt)) AS BUN
           , MAX( DECODE( yorn, 'B', cnt)) AS BBN
           
            FROM ( 
             select bookid,yorn,count(yorn) as cnt from TB_LM_OPINIONYN where opinionid in (select opinionid from TB_LM_WEWONOPINION where commissionid=#{commissionid}) and yorn is not null
                group by bookid,yorn order by bookid
            ) group by bookid
        )c
		WHERE
			a.bookid = b.bookid
			and a.bookid = c.bookid(+)
		AND
			COMMISSIONID = #{commissionid}
	</select>	
	
	<select id="commissionSql.selectOpinionList" resultType="HashMap">
       
			 	SELECT 
		 			OPINIONID,
					COMMISSIONID, 
					USERNO,
					(SELECT user_nm FROM TB_COM_HRIS WHERE USER_ID = a.USERNO) as USERNAME,
					OPINION,
					OPGBN,
					DECODE(YORN, 'Y', '가결', 'N', '부결', 'S', '보류', 'N', '수정가결', YORN) as YORN,
					INDT,
					B.PCFILENAME,B.SERVERFILENAME		,
					(select GROUP_CONCAT(title) 
					 from tb_lm_rulehistory where bookid in
						(select bookid from tb_lm_opinionyn where opinionid=a.opinionid)
					) TITLE            	
			 	FROM TB_LM_WEWONOPINION A,TB_BBS_FILE B
			 	WHERE COMMISSIONID = #{commissionid}
			 	AND B.PST_MNG_NO(+)=A.OPINIONID
			 	AND OPGBN = #{opGbn}
			 	<if test="userno != null and userno != ''">
					and userno = #{userno}
				</if>
	 	
	 </select>

	 <select id="commissionSql.selectOpinionInfo" resultType="HashMap">
	 	SELECT 
 			OPINIONID,
			COMMISSIONID, 
			USERNO,
			(SELECT user_nm FROM TB_COM_HRIS WHERE USER_ID = a.USERNO) as USERNAME,
			OPINION,
			OPGBN,
			YORN,
			INDT,
			B.PCFILENAME,B.SERVERFILENAME
	 	FROM TB_LM_WEWONOPINION a ,TB_BBS_FILE B
	 	WHERE OPINIONID = #{opinionid}
	 	AND B.PST_MNG_NO(+)=A.OPINIONID
	 </select>
	 
	 <select id="commissionSql.selectOpinionYn" resultType="HashMap">
	 	SELECT 
 			a.OPINIONYNID,
		    a.OPINIONID,
		    a.USERNO,
		    a.BOOKID,
		    a.YORN,
		    b.TITLE,
		    nvl(c.BYY,0) BYY,
	        nvl(c.BNN,0) BNN
	 	FROM TB_LM_OPINIONYN a , TB_LM_RULEHISTORY b,
        	(
        	SELECT bookid,MAX( DECODE( yorn, 'Y', cnt)) AS BYY
           	, MAX( DECODE( yorn, 'N', cnt)) AS BNN
            FROM ( 
    		         select bookid,yorn,count(yorn) as cnt from TB_LM_OPINIONYN where opinionid in (select opinionid from TB_LM_WEWONOPINION where commissionid=
                                                                                            (select distinct(COMMISSIONID) from TB_LM_WEWONOPINION where OPINIONID =  #{opinionid})
                                                                                           ) and yorn is not null
            		 group by bookid,yorn order by bookid
	            ) group by bookid
            )c  
	 	WHERE OPINIONID = #{opinionid}
	 	AND a.BOOKID = b.BOOKID
	 	and b.bookid = c.bookid(+)
	 </select>
	 
	 <select id="commissionSql.selectGetfileName" resultType="HashMap">
		select * from tb_lm_rulefile where bookid=#{bookid} and simsacd='REVI' and filecd='AN'
	 </select>
</mapper>
